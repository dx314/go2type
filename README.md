# go2type

A Go to TypeScript API client generator.

## Overview

go2type is a tool that generates TypeScript API clients from Go server code. It parses Go structs and handler functions, generating corresponding TypeScript types and API client functions.

The generator can produce standard query functions, React hooks, or React Query hooks based on configuration.

## Features

- Generates TypeScript types from Go structs
- Creates API client functions from Go handler functions
- Supports generation of:
  - Standard query functions
  - React hooks
  - @tanstack/react-query hooks
- Customizable type mappings
- Automatically parse time.Time as Date objects
- Prettier formatting support
- Automatic configuration initialization

## Installation

To install go2type, use the following command:

```
go install github.com/dx314/go2type@latest
```

## Usage

go2type provides two main commands:

1. `init`: Initialize a new configuration file
2. `generate`: Generate TypeScript files based on the configuration

### Initializing Configuration

To create a new configuration file, run:

```
go2type init
```

This command will:
- Check for existing Go handlers in your project
- Detect the presence of React or @tanstack/react-query
- Find Prettier in your project or system PATH
- Create a `go2type.yaml` file with default settings

### Generating TypeScript Files

To generate TypeScript files based on your configuration, run:

```
go2type generate
```

This command will:
- Load the configuration from `go2type.yaml`
- Parse the specified Go packages
- Generate TypeScript types and API client functions
- Format the output using Prettier (if available)

### Configuration

The `go2type.yaml` file contains the following fields:

```yaml
auth_token: "token"
auth_token_storage: "localStorage" # default: "localStorage"
prettier_path: "client-ui/node_modules/prettier/bin/prettier.cjs"
hooks: react-query
use_date_object: true
packages:
  - path: "internal/app"
    output_path: "client-ui/src/hooks/index.ts"
    type_mappings:
      null.String: "null | string"
      null.Bool: "null | boolean"
      uuid.UUID: "string /* uuid */"
      uuid.NullUUID: "null | string /* uuid */"
```

## Configuration Options

- `auth_token`: Specifies the key used to retrieve the authentication token from the specified storage.
- `auth_token_storage`: Indicates where the authentication token is stored. It can be set to `"localStorage"` or `"sessionStorage"`. Defaults to `"localStorage"`.
- `prettier_path`: Specifies the path to the Prettier configuration file, used for formatting the generated TypeScript code.
- `hooks`: Indicates the type of hooks to generate. In this example, it's set to generate React Query hooks.
- `use_date_object`: When set to `true`, date fields will be treated as JavaScript Date objects. Defaults to `false`.
- `packages`: Defines the Go packages to process and where to output the generated TypeScript code.
- `type_mappings`: Allows you to specify custom mappings from Go types to TypeScript types.

Remember to adjust the configuration according to your project's specific needs and structure.

## Authentication Token

The `auth_token` field in the configuration specifies the key used to retrieve the authentication token from the specified storage. This token is automatically included in the headers of all API requests generated by go2type.

The `auth_token_storage` field determines where the authentication token is stored. It can be set to either:
- `"localStorage"` (default): The token will be retrieved from and stored in localStorage.
- `"sessionStorage"`: The token will be retrieved from and stored in sessionStorage.

For example, if your configuration has:

```yaml
auth_token: "myAuthToken"
auth_token_storage: "sessionStorage"
```

go2type will look for a token stored under the key "myAuthToken" in sessionStorage. The generated API calls will include this token in their headers.

If `auth_token_storage` is not specified, it defaults to "localStorage".

### Mapping External Types

When using external packages or custom types in your Go code, you need to provide mappings to their TypeScript equivalents. This is particularly important for types from packages like `pgx` or `pgtype.

For example, to map types from the `pgtype` package, you can add them to the `type_mappings` section in your `go2type.yaml`:

```yaml
packages:
  - path: "internal/app"
    output_path: "client-ui/src/hooks/index.ts"
    type_mappings:
      pgtype.UUID: "string"
      pgtype.Timestamptz: "string"
      pgtype.Numeric: "string"
```

This ensures that go2type correctly translates these types to TypeScript. You may need to adjust the TypeScript types based on how you handle these types in your frontend code.

## Go Code Examples

Handler function with comments:

```go
// @Method GET
// @Path /users/:id
// @Input GetUserInput
// @Output User
// @Header input:X-Custom-Header
// @Header localStorage:X-Auth-Token
// @Header sessionStorage:X-Session-ID
func GetUserHandler(w http.ResponseWriter, r *http.Request) {
    // Handler implementation
}
```

In the example above, the `@Header` directive specifies the source of each header:
- `input:X-Custom-Header`: The header value will be provided as an input parameter
- `localStorage:X-Auth-Token`: The header value will be retrieved from localStorage
- `sessionStorage:X-Session-ID`: The header value will be retrieved from sessionStorage

If no source is specified, it defaults to `input`.

Go struct:

```go
type User struct {
    ID        int       `json:"id"`
    Name      string    `json:"name"`
    Email     string    `json:"email"`
    CreatedAt time.Time `json:"created_at"`
}
```

## Generated TypeScript

Types:

```typescript
export type User = {
  id: number;
  name: string;
  email: string;
  created_at: Date;
};
```

Standard query function:

```typescript
export const GetUserQuery = async (
  id: string,
  input: GetUserInput,
  X_Custom_Header: string
): Promise<User> => {
  const headers = {
    'X-Custom-Header': X_Custom_Header,
    'X-Auth-Token': localStorage.getItem('X-Auth-Token') || '',
    'X-Session-ID': sessionStorage.getItem('X-Session-ID') || '',
  };
  // Implementation
};
```

@tanstack/react-query hook:

```typescript
export const useGetUser = (
        id: string,
        input: GetUserInput,
        X_Custom_Header: string,
        options?: Omit<UseQueryOptions<User, APIError>, "queryKey" | "queryFn">
) =>
        useQuery<User, APIError>({
          queryKey: ["GetUser", id, input, X_Custom_Header],
          queryFn: () => GetUserQuery(id, input, X_Custom_Header),
          ...options,
        });
```

## License

MIT License

Copyright (c) 2024 Alex Dunmow

## Contributing

Contributions are welcome! Please submit a pull request or open an issue to discuss potential changes.
